<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªçc Ngo·∫°i Ng·ªØ M·ªói Ng√†y (ƒêƒÉng Nh·∫≠p)</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&family=Noto+Sans+SC:wght@400;700&family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body {
            font-family: 'Nunito', sans-serif;
            background-color: #f8fafc;
        }
        body.mode-jp { background-color: #fdf2f8; }
        body.mode-cn { background-color: #fef2f2; }
        
        .jp-font { font-family: 'Noto Sans JP', sans-serif; }
        .cn-font { font-family: 'Noto Sans SC', sans-serif; }
        
        .card-flip { perspective: 1000px; }
        .card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            text-align: center;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }
        .card-flip.flipped .card-inner { transform: rotateY(180deg); }
        .card-front, .card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .card-back { transform: rotateY(180deg); }

        .writing-grid {
            background-color: white;
            background-image: 
                linear-gradient(to right, transparent 49.5%, #e5e7eb 49.5%, #e5e7eb 50.5%, transparent 50.5%),
                linear-gradient(to bottom, transparent 49.5%, #e5e7eb 49.5%, #e5e7eb 50.5%, transparent 50.5%);
            background-size: 100% 100%;
            border: 2px solid #e5e7eb;
        }
        
        .translate-fab:hover { transform: scale(1.1); }
        .translate-fab { transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); }
        
        /* Auth Animations */
        .fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- DATABASE ---
        const DATA_JP = [
            { id: 'j1', main: "ÁßÅ", sub: "„Çè„Åü„Åó", meaning: "T√¥i", level: "N5", note: "watashi" },
            { id: 'j2', main: "Áå´", sub: "„Å≠„Åì", meaning: "Con m√®o", level: "N5", note: "neko" },
            { id: 'j3', main: "È£ü„Åπ„Çã", sub: "„Åü„Åπ„Çã", meaning: "ƒÇn", level: "N5", note: "taberu" },
            { id: 'j4', main: "Â±±", sub: "„ÇÑ„Åæ", meaning: "N√∫i", level: "N5", note: "yama" },
            { id: 'j5', main: "ÂÖàÁîü", sub: "„Åõ„Çì„Åõ„ÅÑ", meaning: "Gi√°o vi√™n", level: "N5", note: "sensei" },
            { id: 'j11', main: "‰ºöË≠∞", sub: "„Åã„ÅÑ„Åé", meaning: "Cu·ªôc h·ªçp", level: "N4", note: "kaigi" },
            { id: 'j12', main: "‰ΩèÊâÄ", sub: "„Åò„ÇÖ„ÅÜ„Åó„Çá", meaning: "ƒê·ªãa ch·ªâ", level: "N4", note: "juusho" },
            { id: 'j21', main: "Âú∞ÁêÉ", sub: "„Å°„Åç„ÇÖ„ÅÜ", meaning: "Tr√°i ƒë·∫•t", level: "N3", note: "chikyuu" },
            { id: 'j31', main: "ÂΩ±Èüø", sub: "„Åà„ÅÑ„Åç„Çá„ÅÜ", meaning: "·∫¢nh h∆∞·ªüng", level: "N2", note: "eikyou" },
            { id: 'j41', main: "Ê¶ÇÂøµ", sub: "„Åå„ÅÑ„Å≠„Çì", meaning: "Kh√°i ni·ªám", level: "N1", note: "gainen" }
        ];

        const DATA_CN = [
            { id: 'c1', main: "Êàë", sub: "w«í", meaning: "T√¥i", level: "HSK1", note: "Ng√£" },
            { id: 'c2', main: "‰Ω†Â•Ω", sub: "n«ê h«éo", meaning: "Xin ch√†o", level: "HSK1", note: "Nhƒ© h·∫£o" },
            { id: 'c3', main: "Áå´", sub: "mƒÅo", meaning: "Con m√®o", level: "HSK1", note: "Mi√™u" },
            { id: 'c4', main: "ÂêÉ", sub: "chƒ´", meaning: "ƒÇn", level: "HSK1", note: "Ng·∫•t" },
            { id: 'c5', main: "‰π¶", sub: "sh≈´", meaning: "S√°ch", level: "HSK1", note: "Th∆∞" },
            { id: 'c11', main: "Â∏ÆÂä©", sub: "bƒÅngzh√π", meaning: "Gi√∫p ƒë·ª°", level: "HSK2", note: "Bang tr·ª£" },
            { id: 'c21', main: "ÁéØÂ¢É", sub: "hu√°nj√¨ng", meaning: "M√¥i tr∆∞·ªùng", level: "HSK3", note: "Ho√†n c·∫£nh" },
            { id: 'c31', main: "Êä±Ê≠â", sub: "b√†oqi√†n", meaning: "Xin l·ªói", level: "HSK4", note: "B√£o khi·ªÉm" },
            { id: 'c41', main: "ÊäΩË±°", sub: "ch≈çuxi√†ng", meaning: "Tr·ª´u t∆∞·ª£ng", level: "HSK5", note: "Tr·ª´u t∆∞·ª£ng" },
            { id: 'c51', main: "Ëæ©Ëß£", sub: "bi√†njiƒõ", meaning: "Bi·ªán gi·∫£i", level: "HSK6", note: "Bi·ªán gi·∫£i" }
        ];

        // --- COMPONENTS ---
        
        // 1. Auth Component (ƒê√£ b·ªè ch·∫ø ƒë·ªô kh√°ch)
        const AuthScreen = ({ onLogin }) => {
            const [isRegister, setIsRegister] = useState(false);
            const [username, setUsername] = useState("");
            const [password, setPassword] = useState("");
            const [error, setError] = useState("");
            const [showPwd, setShowPwd] = useState(false);

            const handleSubmit = (e) => {
                e.preventDefault();
                setError("");
                
                if (!username.trim() || !password.trim()) {
                    setError("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin.");
                    return;
                }

                const users = JSON.parse(localStorage.getItem('app_users') || '{}');

                if (isRegister) {
                    if (users[username]) {
                        setError("T√†i kho·∫£n n√†y ƒë√£ t·ªìn t·∫°i.");
                        return;
                    }
                    users[username] = password; 
                    localStorage.setItem('app_users', JSON.stringify(users));
                    onLogin(username);
                } else {
                    if (users[username] && users[username] === password) {
                        onLogin(username);
                    } else {
                        setError("Sai t√™n ƒëƒÉng nh·∫≠p ho·∫∑c m·∫≠t kh·∫©u.");
                    }
                }
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-gray-50 px-4">
                    <div className="max-w-md w-full bg-white rounded-2xl shadow-xl overflow-hidden fade-in relative">
                        <div className="bg-gradient-to-r from-blue-500 to-purple-600 p-8 text-center">
                            <h1 className="text-2xl font-bold text-white leading-tight">H·ªçc T·ª´ V·ª±ng Nh·∫≠t - Trung M·ªói Ng√†y</h1>
                        </div>
                        
                        <div className="p-8">
                            <h2 className="text-2xl font-bold text-gray-800 text-center mb-6">
                                {isRegister ? "ƒêƒÉng K√Ω T√†i Kho·∫£n" : "ƒêƒÉng Nh·∫≠p"}
                            </h2>
                            
                            {error && (
                                <div className="mb-4 p-3 bg-red-50 text-red-600 text-sm rounded-lg flex items-center gap-2">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
                                    {error}
                                </div>
                            )}

                            <form onSubmit={handleSubmit} className="space-y-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">T√™n ƒëƒÉng nh·∫≠p</label>
                                    <input 
                                        type="text" 
                                        value={username}
                                        onChange={(e) => setUsername(e.target.value)}
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition"
                                        placeholder="V√≠ d·ª•: hocvien123"
                                    />
                                </div>
                                
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">M·∫≠t kh·∫©u</label>
                                    <div className="relative">
                                        <input 
                                            type={showPwd ? "text" : "password"}
                                            value={password}
                                            onChange={(e) => setPassword(e.target.value)}
                                            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition"
                                            placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                                        />
                                        <button 
                                            type="button"
                                            onClick={() => setShowPwd(!showPwd)}
                                            className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600"
                                        >
                                            {showPwd ? <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg> : <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>}
                                        </button>
                                    </div>
                                </div>

                                <button 
                                    type="submit"
                                    className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition-all shadow-lg shadow-blue-200 mt-2"
                                >
                                    {isRegister ? "ƒêƒÉng K√Ω & B·∫Øt ƒê·∫ßu H·ªçc" : "ƒêƒÉng Nh·∫≠p"}
                                </button>
                            </form>
                            
                            <div className="mt-4 text-center space-y-3">
                                <div className="text-sm text-gray-600">
                                    {isRegister ? "ƒê√£ c√≥ t√†i kho·∫£n?" : "Ch∆∞a c√≥ t√†i kho·∫£n?"}{" "}
                                    <button 
                                        onClick={() => {setIsRegister(!isRegister); setError("");}}
                                        className="text-blue-600 font-bold hover:underline"
                                    >
                                        {isRegister ? "ƒêƒÉng nh·∫≠p ngay" : "ƒêƒÉng k√Ω mi·ªÖn ph√≠"}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const LevelBadge = ({ level, lang }) => {
            const colors = {
                'N5': 'bg-green-100 text-green-800 border-green-200',
                'N4': 'bg-teal-100 text-teal-800 border-teal-200',
                'N3': 'bg-blue-100 text-blue-800 border-blue-200',
                'N2': 'bg-purple-100 text-purple-800 border-purple-200',
                'N1': 'bg-rose-100 text-rose-800 border-rose-200',
                'HSK1': 'bg-orange-100 text-orange-800 border-orange-200',
                'HSK2': 'bg-amber-100 text-amber-800 border-amber-200',
                'HSK3': 'bg-yellow-100 text-yellow-800 border-yellow-200',
                'HSK4': 'bg-lime-100 text-lime-800 border-lime-200',
                'HSK5': 'bg-emerald-100 text-emerald-800 border-emerald-200',
                'HSK6': 'bg-red-100 text-red-800 border-red-200',
            };
            return <span className={`px-2 py-1 rounded-full text-xs font-bold border ${colors[level] || 'bg-gray-100'}`}>{level}</span>;
        };

        const WordCard = ({ word, lang }) => {
            const [isFlipped, setIsFlipped] = useState(false);
            const isJP = lang === 'JP';
            const themeColor = isJP ? 'border-pink-200 text-pink-600' : 'border-red-200 text-red-600';
            const bgGradient = isJP ? 'from-pink-50' : 'from-red-50';
            const fontClass = isJP ? 'jp-font' : 'cn-font';

            return (
                <div className="w-full h-64 cursor-pointer group" onClick={() => setIsFlipped(!isFlipped)}>
                    <div className={`card-flip w-full h-full duration-500 ${isFlipped ? 'flipped' : ''}`}>
                        <div className="card-inner w-full h-full relative">
                            <div className={`card-front bg-white border-2 hover:border-opacity-100 border-opacity-60 transition-colors ${themeColor}`}>
                                <div className="absolute top-4 right-4"><LevelBadge level={word.level} lang={lang} /></div>
                                <div className="text-center">
                                    <p className="text-gray-400 text-sm mb-2 font-medium">L·∫≠t th·∫ª</p>
                                    <h2 className={`${fontClass} text-5xl font-bold text-gray-800 mb-2`}>{word.main}</h2>
                                    <p className="text-gray-300 text-lg">?</p>
                                </div>
                            </div>
                            <div className={`card-back bg-gradient-to-br ${bgGradient} to-white border-2 ${themeColor}`}>
                                <div className="absolute top-4 right-4"><LevelBadge level={word.level} lang={lang} /></div>
                                <div className="flex flex-col items-center justify-center p-4">
                                    <p className={`${fontClass} text-3xl font-bold mb-1`}>{word.sub}</p>
                                    <p className="text-gray-500 text-sm italic mb-4">{word.note}</p>
                                    <div className={`w-12 h-1 rounded-full mb-4 opacity-30 bg-current`}></div>
                                    <p className="text-xl font-bold text-gray-800 mb-2">{word.meaning}</p>
                                    <p className="text-xs text-gray-400 mt-4">{isJP ? 'Kanji' : 'Hanzi'}: {word.main}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const CanvasArea = ({ word, lang }) => {
            const canvasRef = useRef(null);
            const [isDrawing, setIsDrawing] = useState(false);
            const isJP = lang === 'JP';
            const borderColor = isJP ? 'border-pink-100' : 'border-red-100';
            const btnColor = isJP ? 'text-pink-500 bg-pink-50' : 'text-red-500 bg-red-50';

            useEffect(() => {
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                const rect = canvas.getBoundingClientRect();
                canvas.width = rect.width;
                canvas.height = rect.height;
                ctx.lineWidth = 4;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                ctx.strokeStyle = '#333';
            }, []);

            const startDrawing = (e) => {
                const ctx = canvasRef.current.getContext('2d');
                const { x, y } = getPos(e);
                ctx.beginPath();
                ctx.moveTo(x, y);
                setIsDrawing(true);
            };
            const draw = (e) => {
                if (!isDrawing) return;
                const ctx = canvasRef.current.getContext('2d');
                const { x, y } = getPos(e);
                ctx.lineTo(x, y);
                ctx.stroke();
            };
            const getPos = (e) => {
                const rect = canvasRef.current.getBoundingClientRect();
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                return { x: clientX - rect.left, y: clientY - rect.top };
            };

            return (
                <div className={`flex flex-col items-center bg-white p-4 rounded-xl shadow-sm border ${borderColor}`}>
                    <div className="flex justify-between w-full mb-2 items-center">
                        <span className={`text-2xl font-bold mr-2 ${isJP ? 'jp-font' : 'cn-font'}`}>{word.main}</span>
                        <button onClick={() => {
                            const cvs = canvasRef.current;
                            cvs.getContext('2d').clearRect(0,0,cvs.width,cvs.height);
                        }} className={`text-xs font-medium px-2 py-1 rounded ${btnColor}`}>X√≥a</button>
                    </div>
                    <div className="relative w-full aspect-square max-w-[200px]">
                        <canvas
                            ref={canvasRef}
                            className="w-full h-full writing-grid cursor-crosshair rounded touch-none"
                            onMouseDown={startDrawing} onMouseMove={draw} onMouseUp={() => setIsDrawing(false)} onMouseLeave={() => setIsDrawing(false)}
                            onTouchStart={startDrawing} onTouchMove={draw} onTouchEnd={() => setIsDrawing(false)}
                        />
                    </div>
                </div>
            );
        };

        const TranslationWidget = ({ lang }) => {
            const [isOpen, setIsOpen] = useState(false);
            const [text, setText] = useState("");

            const handleTranslate = () => {
                if (!text.trim()) return;
                const sourceLang = lang === 'JP' ? 'ja' : 'zh-CN';
                const url = `https://translate.google.com/?sl=${sourceLang}&tl=vi&text=${encodeURIComponent(text)}&op=translate`;
                window.open(url, '_blank');
                setIsOpen(false);
            };

            return (
                <div className="fixed bottom-6 right-6 z-50 flex flex-col items-end">
                    {isOpen && (
                        <div className="mb-4 bg-white p-4 rounded-xl shadow-xl border border-gray-200 w-72 translate-modal">
                            <h3 className="font-bold text-gray-700 mb-2 flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1 4-10z"/></svg>
                                D·ªãch nhanh ({lang === 'JP' ? 'Nh·∫≠t' : 'Trung'} ‚Üí Vi·ªát)
                            </h3>
                            <textarea 
                                className="w-full p-2 border border-gray-300 rounded-lg mb-3 text-sm focus:outline-none focus:ring-2 focus:ring-blue-400" rows="3"
                                placeholder={`Nh·∫≠p t·ª´ ${lang === 'JP' ? 'ti·∫øng Nh·∫≠t' : 'ti·∫øng Trung'}...`}
                                value={text} onChange={(e) => setText(e.target.value)}
                                onKeyDown={(e) => e.key === 'Enter' && !e.shiftKey && handleTranslate()}
                            ></textarea>
                            <div className="flex justify-end gap-2">
                                <button onClick={() => setIsOpen(false)} className="px-3 py-1 text-sm text-gray-500 hover:bg-gray-100 rounded">ƒê√≥ng</button>
                                <button onClick={handleTranslate} className="px-3 py-1 text-sm bg-blue-600 text-white rounded hover:bg-blue-700 font-medium">D·ªãch ngay</button>
                            </div>
                        </div>
                    )}
                    <button onClick={() => setIsOpen(!isOpen)} className="translate-fab w-14 h-14 bg-blue-600 text-white rounded-full shadow-lg flex items-center justify-center hover:bg-blue-700">
                        {isOpen ? <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg> 
                        : <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M5 8l6 6"/><path d="M4 14l6-6 2-3"/><path d="M2 5h12"/><path d="M7 2h1"/><path d="M22 22l-5-10-5 10"/><path d="M14 18h6"/></svg>}
                    </button>
                </div>
            );
        };

        const App = () => {
            const [currentUser, setCurrentUser] = useState(null); // Auth State
            const [lang, setLang] = useState('JP');
            const [words, setWords] = useState([]);
            const [history, setHistory] = useState([]);
            const [mode, setMode] = useState('AUTO');
            const [isNewDay, setIsNewDay] = useState(false);
            const [loading, setLoading] = useState(true);

            // Auto-login on mount
            useEffect(() => {
                const savedUser = localStorage.getItem('current_session_user');
                if (savedUser) {
                    setCurrentUser(savedUser);
                } else {
                    setLoading(false);
                }
            }, []);

            // Data Key Prefix based on User
            const getKeyPrefix = (user) => {
                const u = user || currentUser;
                if (!u) return '';
                // Format: "username_jp_" or "username_cn_"
                return `${u}_${lang === 'JP' ? 'jp_' : 'cn_'}`;
            };

            const fullData = lang === 'JP' ? DATA_JP : DATA_CN;
            const levels = lang === 'JP' ? ['N5', 'N4', 'N3', 'N2', 'N1'] : ['HSK1', 'HSK2', 'HSK3', 'HSK4', 'HSK5', 'HSK6'];

            // Load data when user or lang changes
            useEffect(() => {
                if (!currentUser) return;
                
                // Update CSS class for theme
                document.body.className = lang === 'JP' ? 'mode-jp' : 'mode-cn';

                setLoading(true);
                const prefix = getKeyPrefix();
                const today = new Date().toISOString().split('T')[0];
                
                const savedDate = localStorage.getItem(prefix + 'last_visit');
                const savedWords = JSON.parse(localStorage.getItem(prefix + 'daily_words') || '[]');
                const savedHistory = JSON.parse(localStorage.getItem(prefix + 'history') || '[]');
                const savedMode = localStorage.getItem(prefix + 'mode') || 'AUTO';

                setHistory(savedHistory);
                setMode(savedMode);

                if (savedDate === today && savedWords.length > 0) {
                    setWords(savedWords);
                    setIsNewDay(false);
                } else {
                    // Generate new words
                    generateWords(savedHistory, today, savedMode, prefix);
                    setIsNewDay(true);
                }
                setLoading(false);
            }, [currentUser, lang]);

            const generateWords = (currentHistory, dateStr, currentMode, prefix) => {
                const available = fullData.filter(w => !currentHistory.includes(w.id));
                let selected = [];

                if (currentMode === 'AUTO') {
                    for (const lvl of levels) {
                        if (selected.length >= 5) break;
                        const inLevel = available.filter(w => w.level === lvl);
                        if (inLevel.length > 0) {
                            const needed = 5 - selected.length;
                            const shuffled = inLevel.sort(() => 0.5 - Math.random());
                            selected = [...selected, ...shuffled.slice(0, needed)];
                        }
                    }
                } else {
                    const inLevel = available.filter(w => w.level === currentMode);
                    selected = inLevel.sort(() => 0.5 - Math.random()).slice(0, 5);
                }

                setWords(selected);
                
                localStorage.setItem(prefix + 'daily_words', JSON.stringify(selected));
                localStorage.setItem(prefix + 'last_visit', dateStr);
                
                if (selected.length > 0) {
                    const newHistory = [...new Set([...currentHistory, ...selected.map(w => w.id)])];
                    setHistory(newHistory);
                    localStorage.setItem(prefix + 'history', JSON.stringify(newHistory));
                }
            };

            const handleLogin = (username) => {
                localStorage.setItem('current_session_user', username);
                setCurrentUser(username);
            };

            const handleLogout = () => {
                localStorage.removeItem('current_session_user');
                setCurrentUser(null);
                setWords([]);
                document.body.className = '';
            };

            const handleModeChange = (e) => {
                const newMode = e.target.value;
                setMode(newMode);
                const prefix = getKeyPrefix();
                localStorage.setItem(prefix + 'mode', newMode);
                if (confirm('T·∫°o l·∫°i b√†i h·ªçc m·ªõi theo ch·∫ø ƒë·ªô n√†y ngay?')) {
                    generateWords(history, new Date().toISOString().split('T')[0], newMode, prefix);
                }
            };

            const refresh = () => {
                if (confirm('B·ªè qua b√†i h√¥m nay v√† h·ªçc t·ª´ m·ªõi ti·∫øp theo?')) {
                    generateWords(history, new Date().toISOString().split('T')[0], mode, getKeyPrefix());
                }
            };

            const reset = () => {
                if (confirm(`X√≥a to√†n b·ªô l·ªãch s·ª≠ h·ªçc ${lang === 'JP' ? 'Ti·∫øng Nh·∫≠t' : 'Ti·∫øng Trung'} c·ªßa t√†i kho·∫£n ${currentUser}?`)) {
                    const prefix = getKeyPrefix();
                    localStorage.removeItem(prefix + 'daily_words');
                    localStorage.removeItem(prefix + 'last_visit');
                    localStorage.removeItem(prefix + 'history');
                    localStorage.removeItem(prefix + 'mode');
                    window.location.reload();
                }
            };

            // Main Render Logic
            if (!currentUser) {
                return <AuthScreen onLogin={handleLogin} />;
            }
            
            if (loading) return <div className="h-screen flex items-center justify-center text-gray-500">ƒêang t·∫£i d·ªØ li·ªáu c·ªßa {currentUser}...</div>;

            const themeColor = lang === 'JP' ? 'pink' : 'red';
            const accentColor = lang === 'JP' ? 'text-pink-600' : 'text-red-600';

            return (
                <div className="min-h-screen pb-20 relative fade-in">
                    {/* HEADER */}
                    <header className="bg-white shadow-sm sticky top-0 z-10 border-b border-gray-100">
                        <div className="max-w-5xl mx-auto px-4 py-3">
                            <div className="flex flex-col md:flex-row justify-between items-center gap-4">
                                <div className="flex items-center gap-4 w-full md:w-auto justify-between md:justify-start">
                                    <div className="flex items-center gap-2">
                                        <div className={`w-8 h-8 rounded-full flex items-center justify-center font-bold text-xs uppercase bg-gray-800 text-white`}>
                                            {currentUser.substring(0, 2)}
                                        </div>
                                        <div className="flex bg-gray-100 rounded-lg p-1">
                                            <button onClick={() => setLang('JP')} className={`px-3 py-1 rounded-md text-sm font-bold transition-all ${lang === 'JP' ? 'bg-white text-pink-600 shadow-sm' : 'text-gray-500'}`}>Êó•Êú¨Ë™û</button>
                                            <button onClick={() => setLang('CN')} className={`px-3 py-1 rounded-md text-sm font-bold transition-all ${lang === 'CN' ? 'bg-white text-red-600 shadow-sm' : 'text-gray-500'}`}>‰∏≠Êñá</button>
                                        </div>
                                    </div>
                                    
                                    <button onClick={handleLogout} className="md:hidden text-xs text-red-500 font-medium border border-red-100 px-2 py-1 rounded hover:bg-red-50">
                                        ƒêƒÉng xu·∫•t
                                    </button>
                                </div>

                                <div className="flex items-center gap-4">
                                    <select value={mode} onChange={handleModeChange} className="bg-gray-50 border border-gray-300 text-sm rounded-lg p-2 focus:outline-none">
                                        <option value="AUTO">T·ª± ƒë·ªông ({lang==='JP' ? 'N5‚ÜíN1' : 'HSK1‚Üí6'})</option>
                                        {levels.map(l => <option key={l} value={l}>Ch·ªâ h·ªçc {l}</option>)}
                                    </select>
                                    
                                    <div className="text-right hidden sm:block">
                                        <div className="text-xs text-gray-500">Ti·∫øn ƒë·ªô</div>
                                        <div className={`font-bold ${accentColor}`}>{history.length} / {fullData.length}</div>
                                    </div>

                                    <button onClick={handleLogout} className="hidden md:block ml-2 text-sm text-gray-400 hover:text-red-500 transition-colors" title="ƒêƒÉng xu·∫•t">
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </header>

                    {/* MAIN CONTENT */}
                    <main className="max-w-5xl mx-auto px-4 pt-8">
                        <div className="text-center mb-8">
                            <h2 className="text-3xl font-bold text-gray-800 mb-2">
                                <span>Xin ch√†o, <span className={accentColor}>{currentUser}</span>!</span>
                            </h2>
                            <p className="text-gray-500 mb-1">{isNewDay ? "B√†i h·ªçc h√¥m nay c·ªßa b·∫°n" : "√în t·∫≠p b√†i h√¥m nay"}</p>
                            <p className="text-xs text-gray-400 uppercase tracking-wider font-semibold">
                                {new Date().toLocaleDateString('vi-VN', { weekday: 'long', day: 'numeric', month: 'long' })}
                            </p>
                        </div>

                        {words.length > 0 ? (
                            <>
                                <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-6 mb-12">
                                    {words.map(w => <WordCard key={w.id} word={w} lang={lang} />)}
                                </div>
                                <div className="mb-12">
                                    <h3 className="text-xl font-bold text-gray-700 mb-4 border-b pb-2">Luy·ªán vi·∫øt (T·∫≠p ƒë·ªì)</h3>
                                    <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-6">
                                        {words.map(w => <CanvasArea key={`w-${w.id}`} word={w} lang={lang} />)}
                                    </div>
                                </div>
                            </>
                        ) : (
                            <div className="text-center py-10 bg-white rounded-xl shadow-sm border border-gray-100 mx-auto max-w-2xl">
                                <div className="text-6xl mb-4">üéâ</div>
                                <h3 className="text-xl font-bold text-gray-700 mb-2">Tuy·ªát v·ªùi! B·∫°n ƒë√£ ho√†n th√†nh kho t·ª´ v·ª±ng hi·ªán t·∫°i.</h3>
                                <p className="text-gray-500 mb-6">B·∫°n c√≥ mu·ªën th·ª≠ s·ª©c v·ªõi ng√¥n ng·ªØ c√≤n l·∫°i kh√¥ng?</p>
                                <button onClick={() => setLang(lang === 'JP' ? 'CN' : 'JP')} className="px-6 py-2 bg-blue-600 text-white rounded-full hover:bg-blue-700 transition shadow-lg shadow-blue-200">
                                    Chuy·ªÉn sang {lang === 'JP' ? 'Ti·∫øng Trung' : 'Ti·∫øng Nh·∫≠t'}
                                </button>
                            </div>
                        )}

                        <div className="flex justify-center gap-4 mt-8 pt-8 border-t border-gray-200">
                            <button onClick={refresh} className={`px-6 py-2 rounded-full border bg-white hover:bg-gray-50 transition text-sm font-medium ${accentColor} border-current`}>
                                H·ªçc t·ª´ kh√°c (Skip)
                            </button>
                            <button onClick={reset} className="px-6 py-2 rounded-full border border-gray-300 text-gray-500 hover:bg-gray-100 text-sm font-medium">
                                Reset L·ªô tr√¨nh
                            </button>
                        </div>
                    </main>

                    <TranslationWidget lang={lang} />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>